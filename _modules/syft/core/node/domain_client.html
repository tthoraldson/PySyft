
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>syft.core.node.domain_client &#8212; PySyft  documentation</title>
    
  <link href="../../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/pysyft.css" />
    
  <link rel="preload" as="script" href="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../../../index.html">
  <img src="../../../../_static/logo.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../getting_started/index.html">
  Getting Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../api_reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../developer_guide/index.html">
  Contributor Guidelines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../deployment/glossary.html">
  Glossary
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../resources/index.html">
  Resources
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../guides/index.html">
  How-to Guides
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/OpenMined/PySyft" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/openminedorg" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for syft.core.node.domain_client</h1><div class="highlight"><pre>
<span></span><span class="c1"># stdlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="c1"># third party</span>
<span class="kn">from</span> <span class="nn">nacl.signing</span> <span class="kn">import</span> <span class="n">SigningKey</span>
<span class="kn">from</span> <span class="nn">nacl.signing</span> <span class="kn">import</span> <span class="n">VerifyKey</span>
<span class="kn">import</span> <span class="nn">names</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># relative</span>
<span class="kn">from</span> <span class="nn">...</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">...logger</span> <span class="kn">import</span> <span class="n">traceback_and_raise</span>
<span class="kn">from</span> <span class="nn">...util</span> <span class="kn">import</span> <span class="n">bcolors</span>
<span class="kn">from</span> <span class="nn">...util</span> <span class="kn">import</span> <span class="n">print_dynamic_log</span>
<span class="kn">from</span> <span class="nn">...util</span> <span class="kn">import</span> <span class="n">validate_field</span>
<span class="kn">from</span> <span class="nn">..common.message</span> <span class="kn">import</span> <span class="n">SyftMessage</span>
<span class="kn">from</span> <span class="nn">..common.serde.serialize</span> <span class="kn">import</span> <span class="n">_serialize</span> <span class="k">as</span> <span class="n">serialize</span>  <span class="c1"># noqa: F401</span>
<span class="kn">from</span> <span class="nn">..common.uid</span> <span class="kn">import</span> <span class="n">UID</span>
<span class="kn">from</span> <span class="nn">..io.address</span> <span class="kn">import</span> <span class="n">Address</span>
<span class="kn">from</span> <span class="nn">..io.location</span> <span class="kn">import</span> <span class="n">Location</span>
<span class="kn">from</span> <span class="nn">..io.location.specific</span> <span class="kn">import</span> <span class="n">SpecificLocation</span>
<span class="kn">from</span> <span class="nn">..io.route</span> <span class="kn">import</span> <span class="n">Route</span>
<span class="kn">from</span> <span class="nn">..io.virtual</span> <span class="kn">import</span> <span class="n">VirtualClientConnection</span>
<span class="kn">from</span> <span class="nn">..pointer.pointer</span> <span class="kn">import</span> <span class="n">Pointer</span>
<span class="kn">from</span> <span class="nn">..store.proxy_dataset</span> <span class="kn">import</span> <span class="n">ProxyDataset</span>
<span class="kn">from</span> <span class="nn">..tensor.tensor</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">.abstract.node</span> <span class="kn">import</span> <span class="n">AbstractNodeClient</span>
<span class="kn">from</span> <span class="nn">.common.action.exception_action</span> <span class="kn">import</span> <span class="n">ExceptionMessage</span>
<span class="kn">from</span> <span class="nn">.common.client</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">.common.client_manager.association_api</span> <span class="kn">import</span> <span class="n">AssociationRequestAPI</span>
<span class="kn">from</span> <span class="nn">.common.client_manager.dataset_api</span> <span class="kn">import</span> <span class="n">DatasetRequestAPI</span>
<span class="kn">from</span> <span class="nn">.common.client_manager.role_api</span> <span class="kn">import</span> <span class="n">RoleRequestAPI</span>
<span class="kn">from</span> <span class="nn">.common.client_manager.user_api</span> <span class="kn">import</span> <span class="n">UserRequestAPI</span>
<span class="kn">from</span> <span class="nn">.common.client_manager.vpn_api</span> <span class="kn">import</span> <span class="n">VPNAPI</span>
<span class="kn">from</span> <span class="nn">.common.node_service.get_remaining_budget.get_remaining_budget_messages</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GetRemainingBudgetMessage</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.common.node_service.node_setup.node_setup_messages</span> <span class="kn">import</span> <span class="n">GetSetUpMessage</span>
<span class="kn">from</span> <span class="nn">.common.node_service.object_request.object_request_messages</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CreateBudgetRequestMessage</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.common.node_service.object_transfer.object_transfer_messages</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">LoadObjectMessage</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.common.node_service.request_receiver.request_receiver_messages</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RequestMessage</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.common.node_service.simple.obj_exists</span> <span class="kn">import</span> <span class="n">DoesObjectExistMessage</span>
<span class="kn">from</span> <span class="nn">.common.util</span> <span class="kn">import</span> <span class="n">check_send_to_blob_storage</span>
<span class="kn">from</span> <span class="nn">.common.util</span> <span class="kn">import</span> <span class="n">upload_to_s3_using_presigned</span>
<span class="kn">from</span> <span class="nn">.enums</span> <span class="kn">import</span> <span class="n">PyGridClientEnums</span>
<span class="kn">from</span> <span class="nn">.enums</span> <span class="kn">import</span> <span class="n">RequestAPIFields</span>

<span class="n">SAVE_DATASET_TIMEOUT</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># seconds</span>


<span class="k">class</span> <span class="nc">RequestQueueClient</span><span class="p">(</span><span class="n">AbstractNodeClient</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">RequestHandlerQueueClient</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">UserRequestAPI</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">RoleRequestAPI</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">association</span> <span class="o">=</span> <span class="n">AssociationRequestAPI</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">DatasetRequestAPI</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">requests</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RequestMessage</span><span class="p">]:</span>

        <span class="c1"># relative</span>
        <span class="kn">from</span> <span class="nn">.common.node_service.object_request.object_request_messages</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">GetAllRequestsMessage</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">GetAllRequestsMessage</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">reply_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">address</span>
        <span class="p">)</span>

        <span class="n">requests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">send_immediate_msg_with_reply</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">requests</span>  <span class="c1"># type: ignore</span>

        <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">gc_enabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">request</span><span class="o">.</span><span class="n">owner_client_if_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span>

        <span class="k">return</span> <span class="n">requests</span>

    <span class="k">def</span> <span class="nf">get_request_id_from_object_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_id</span><span class="p">:</span> <span class="n">UID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UID</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">object_id</span> <span class="o">==</span> <span class="n">object_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">req</span><span class="o">.</span><span class="n">request_id</span>

        <span class="k">return</span> <span class="n">object_id</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RequestMessage</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">request</span>
            <span class="n">traceback_and_raise</span><span class="p">(</span>
                <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No such request found for string id:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">traceback_and_raise</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Please pass in a string or int key&quot;</span><span class="p">))</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;should not get here&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO:</span>
        <span class="c1"># Replace all the hardcoded string by enums / abstractions.</span>
        <span class="n">request_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
                <span class="s2">&quot;Email&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">user_email</span><span class="p">,</span>
                <span class="s2">&quot;Role&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">user_role</span><span class="p">,</span>
                <span class="s2">&quot;Request Type&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">request_type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>  <span class="c1"># type: ignore</span>
                <span class="s2">&quot;Status&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                <span class="s2">&quot;Reason&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">request_description</span><span class="p">,</span>
                <span class="s2">&quot;Request ID&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;Requested Object&#39;s ID&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">object_id</span>
                <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">request_type</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Requested Object&#39;s tags&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">object_tags</span><span class="p">,</span>
                <span class="s2">&quot;Requested Budget&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">requested_budget</span>
                <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">request_type</span> <span class="o">==</span> <span class="s2">&quot;budget&quot;</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Current Budget&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">current_budget</span>
                <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">request_type</span> <span class="o">==</span> <span class="s2">&quot;budget&quot;</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">request_lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">print_local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">log_local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout_secs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">element_quota</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">handler_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_options</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">UID</span><span class="p">(),</span>
            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
            <span class="n">print_local</span><span class="o">=</span><span class="n">print_local</span><span class="p">,</span>
            <span class="n">log_local</span><span class="o">=</span><span class="n">log_local</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">timeout_secs</span><span class="o">=</span><span class="n">timeout_secs</span><span class="p">,</span>
            <span class="n">element_quota</span><span class="o">=</span><span class="n">element_quota</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_handler</span><span class="p">(</span><span class="n">handler_opts</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">handler_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_handler</span><span class="p">(</span><span class="n">handler_opts</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">id_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">handler</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_handler</span><span class="p">(</span><span class="n">id_str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_options</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">print_local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">log_local</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout_secs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">element_quota</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">handler_opts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;accept&quot;</span><span class="p">,</span> <span class="s2">&quot;deny&quot;</span><span class="p">]:</span>
            <span class="n">traceback_and_raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Action must be &#39;accept&#39; or &#39;deny&#39;&quot;</span><span class="p">))</span>
        <span class="n">handler_opts</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">action</span>
        <span class="n">handler_opts</span><span class="p">[</span><span class="s2">&quot;print_local&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">print_local</span><span class="p">)</span>
        <span class="n">handler_opts</span><span class="p">[</span><span class="s2">&quot;log_local&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">log_local</span><span class="p">)</span>

        <span class="n">handler_opts</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">handler_opts</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">handler_opts</span><span class="p">[</span><span class="s2">&quot;timeout_secs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeout_secs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">element_quota</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handler_opts</span><span class="p">[</span><span class="s2">&quot;element_quota&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">element_quota</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">UID</span><span class="p">()</span>
        <span class="n">handler_opts</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="k">return</span> <span class="n">handler_opts</span>

    <span class="k">def</span> <span class="nf">_update_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">keep</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># relative</span>
        <span class="kn">from</span> <span class="nn">..common.node_service.request_handler.request_handler_messages</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">UpdateRequestHandlerMessage</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">UpdateRequestHandlerMessage</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">request_handler</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="n">keep</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">send_immediate_msg_without_reply</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RequestHandlerQueueClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="c1"># relative</span>
        <span class="kn">from</span> <span class="nn">..common.node_service.request_handler.request_handler_messages</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">GetAllRequestHandlersMessage</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">GetAllRequestHandlersMessage</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">reply_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">address</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">validate_field</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">send_immediate_msg_with_reply</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">),</span> <span class="s2">&quot;handlers&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        allow three ways to get an request handler:</span>
<span class="sd">            1. use id: str</span>
<span class="sd">            2. use tag: str</span>
<span class="sd">            3. use index: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">match_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">handler</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">handler</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">handler</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]:</span>
                    <span class="n">matches</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">match_handler</span> <span class="o">=</span> <span class="n">handler</span>
            <span class="k">if</span> <span class="n">matches</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">match_handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">match_handler</span>
            <span class="k">elif</span> <span class="n">matches</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;More than one item with tag:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No such request found for string id:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Please pass in a string or int key&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pandas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">_get_time_remaining</span><span class="p">(</span><span class="n">handler</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">timeout_secs</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout_secs&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">timeout_secs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">created_time</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;created_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">rem</span> <span class="o">=</span> <span class="n">timeout_secs</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">created_time</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>

        <span class="n">handler_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">handler</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">],</span>
                <span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="n">handler</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">handler</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
                <span class="s2">&quot;remaining time (s):&quot;</span><span class="p">:</span> <span class="n">_get_time_remaining</span><span class="p">(</span><span class="n">handler</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">handler_lines</span><span class="p">)</span>


<div class="viewcode-block" id="DomainClient"><a class="viewcode-back" href="../../../../api_reference/syft.core.node.domain_client.html#syft.core.node.domain_client.DomainClient">[docs]</a><span class="k">class</span> <span class="nc">DomainClient</span><span class="p">(</span><span class="n">Client</span><span class="p">):</span>

    <span class="n">domain</span><span class="p">:</span> <span class="n">SpecificLocation</span>
    <span class="n">requests</span><span class="p">:</span> <span class="n">RequestQueueClient</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">routes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Route</span><span class="p">],</span>
        <span class="n">domain</span><span class="p">:</span> <span class="n">SpecificLocation</span><span class="p">,</span>
        <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Location</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Location</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">vm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Location</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">signing_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SigningKey</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verify_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VerifyKey</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">routes</span><span class="o">=</span><span class="n">routes</span><span class="p">,</span>
            <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">vm</span><span class="o">=</span><span class="n">vm</span><span class="p">,</span>
            <span class="n">signing_key</span><span class="o">=</span><span class="n">signing_key</span><span class="p">,</span>
            <span class="n">verify_key</span><span class="o">=</span><span class="n">verify_key</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="n">RequestQueueClient</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">post_init</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">UserRequestAPI</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">RoleRequestAPI</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">association</span> <span class="o">=</span> <span class="n">AssociationRequestAPI</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">DatasetRequestAPI</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vpn</span> <span class="o">=</span> <span class="n">VPNAPI</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">obj_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">:</span> <span class="n">UID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">DoesObjectExistMessage</span><span class="p">(</span><span class="n">obj_id</span><span class="o">=</span><span class="n">obj_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_immediate_msg_with_reply</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">payload</span>  <span class="c1"># type: ignore</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">privacy_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">GetRemainingBudgetMessage</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">reply_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_immediate_msg_with_reply</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">budget</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">request_budget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">skip_checks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_checks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eps</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">eps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please specify how much more epsilon you want:&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Why should the domain owner give you more epsilon:&quot;</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">CreateBudgetRequestMessage</span><span class="p">(</span>
            <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
            <span class="n">budget</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
            <span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send_immediate_msg_without_reply</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Requested &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; epsilon of budget. Call .privacy_budget to see if your budget has arrived!&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">obj_ptr</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Pointer</span><span class="p">],</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">,</span> <span class="n">pointable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">RequestAPIFields</span><span class="o">.</span><span class="n">ADDRESS</span><span class="p">:</span> <span class="n">serialize</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
            <span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">PyGridClientEnums</span><span class="o">.</span><span class="n">ENCODING</span><span class="p">),</span>
            <span class="n">RequestAPIFields</span><span class="o">.</span><span class="n">UID</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_ptr</span><span class="o">.</span><span class="n">id_at_location</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="n">RequestAPIFields</span><span class="o">.</span><span class="n">POINTABLE</span><span class="p">:</span> <span class="n">pointable</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_perform_grid_request</span><span class="p">(</span><span class="n">grid_msg</span><span class="o">=</span><span class="n">LoadObjectMessage</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">domain_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">domain_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">domain_name</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&#39;s Domain&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;No Domain Name provided... picking randomly as: &quot;</span> <span class="o">+</span> <span class="n">domain_name</span>
            <span class="p">)</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;domain_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain_name</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="n">RequestAPIFields</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Node reset will delete the data, as well as the requests. Do you want to continue (y/N)?&quot;</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">_perform_grid_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">grid_msg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SyftMessage</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Build Syft Message</span>
        <span class="n">content</span><span class="p">[</span><span class="n">RequestAPIFields</span><span class="o">.</span><span class="n">ADDRESS</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span>
        <span class="n">content</span><span class="p">[</span><span class="n">RequestAPIFields</span><span class="o">.</span><span class="n">REPLY_TO</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span>
        <span class="n">signed_msg</span> <span class="o">=</span> <span class="n">grid_msg</span><span class="p">(</span><span class="o">**</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">signing_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">signing_key</span><span class="p">)</span>
        <span class="c1"># Send to the dest</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_immediate_msg_with_reply</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">signed_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ExceptionMessage</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">response</span><span class="o">.</span><span class="n">exception_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">get_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_grid_request</span><span class="p">(</span><span class="n">grid_msg</span><span class="o">=</span><span class="n">GetSetUpMessage</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply_to_network</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AbstractNodeClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">retry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="o">**</span><span class="n">metadata</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">finish</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="n">print_dynamic_log</span><span class="p">(</span><span class="s2">&quot;[1/4] Checking Syft Versions&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">client</span><span class="o">.</span><span class="n">version</span> <span class="ow">and</span> <span class="n">client</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">__version__</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
                <span class="n">success</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bcolors</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;WARNING&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Syft versions mismatch!&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bcolors</span><span class="o">.</span><span class="n">bold</span><span class="p">(</span><span class="s1">&#39;Domain&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">bcolors</span><span class="o">.</span><span class="n">underline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bcolors</span><span class="o">.</span><span class="n">bold</span><span class="p">(</span><span class="s1">&#39;Network&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">bcolors</span><span class="o">.</span><span class="n">underline</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">version</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bcolors</span><span class="o">.</span><span class="n">bold</span><span class="p">(</span><span class="s1">&#39;Environment&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">bcolors</span><span class="o">.</span><span class="n">underline</span><span class="p">(</span><span class="n">__version__</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1mThis may cause unexpected errors, are you willing to continue? (y/N)</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                    <span class="n">success</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">finish</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">return</span>
            <span class="n">finish</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="n">finish</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="n">print_dynamic_log</span><span class="p">(</span><span class="s2">&quot;[2/4] Joining Network&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">join_network</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
            <span class="n">success</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="n">finish</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="n">timeout</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">network_vpn_ip</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">domain_vpn_ip</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">finish</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="n">print_dynamic_log</span><span class="p">(</span><span class="s2">&quot;[3/4] Connecting to Secure VPN&quot;</span><span class="p">)</span>
            <span class="c1"># get the vpn ips</span>
            <span class="k">while</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">connected</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vpn_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vpn_status</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">vpn_status</span><span class="p">[</span><span class="s2">&quot;connected&quot;</span><span class="p">]:</span>
                        <span class="n">finish</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                        <span class="n">success</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                        <span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">finish</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get vpn status. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">finish</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="n">print_dynamic_log</span><span class="p">(</span><span class="s2">&quot;[4/4] Registering on the Secure VPN&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vpn_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to get vpn status.&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">vpn_status</span><span class="p">[</span><span class="s2">&quot;peers&quot;</span><span class="p">]:</span>
                <span class="c1"># sometimes the hostname we give is different to the one tailscale</span>
                <span class="c1"># reports which can convert _ to - so if we change them on both sides</span>
                <span class="c1"># we can safely compare</span>
                <span class="k">if</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">client</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                    <span class="n">network_vpn_ip</span> <span class="o">=</span> <span class="n">peer</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">domain_vpn_ip</span> <span class="o">=</span> <span class="n">vpn_status</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">][</span><span class="s2">&quot;ip&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get vpn host ip. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">network_vpn_ip</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cant find the network node </span><span class="si">{</span><span class="n">client</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">vpn_status</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">domain_vpn_ip</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No host ip in </span><span class="si">{</span><span class="n">vpn_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">association</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="n">domain_vpn_ip</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">network_vpn_ip</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">success</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="n">finish</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">finish</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to apply to network with </span><span class="si">{</span><span class="n">client</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UID</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Location</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This client points to a node, if that node lives within a device</span>
<span class="sd">        or is a device itself, this property will return the Location of that device</span>
<span class="sd">        if it is known by the client.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">device</span>

    <span class="nd">@device</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_device</span><span class="p">:</span> <span class="n">Location</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Location</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This client points to a node, if that node lives within a device</span>
<span class="sd">        or is a device itself and we learn the Location of that device, this setter</span>
<span class="sd">        allows us to save the Location of that device for use later. We use a getter</span>
<span class="sd">        (@property) and setter (@set) explicitly because we want all clients</span>
<span class="sd">        to efficiently save an address object for use when sending messages to their</span>
<span class="sd">        target. That address object will include this information if it is available&quot;&quot;&quot;</span>

        <span class="n">traceback_and_raise</span><span class="p">(</span>
            <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This client points to a domain, you don&#39;t need a Device ID.&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Location</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This client points to a node, if that node lives within a vm</span>
<span class="sd">        or is a vm itself, this property will return the Location of that vm</span>
<span class="sd">        if it is known by the client.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">vm</span>

    <span class="nd">@vm</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">vm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_vm</span><span class="p">:</span> <span class="n">Location</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Location</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This client points to a node, if that node lives within a vm</span>
<span class="sd">        or is a vm itself and we learn the Location of that vm, this setter</span>
<span class="sd">        allows us to save the Location of that vm for use later. We use a getter</span>
<span class="sd">        (@property) and setter (@set) explicitly because we want all clients</span>
<span class="sd">        to efficiently save an address object for use when sending messages to their</span>
<span class="sd">        target. That address object will include this information if it is available&quot;&quot;&quot;</span>

        <span class="n">traceback_and_raise</span><span class="p">(</span>
            <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This client points to a device, you don&#39;t need a VM Location.&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">no_dash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">no_dash</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">update_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ptr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">pandas</span>

    <span class="k">def</span> <span class="nf">vpn_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vpn</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">assets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_checks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">536870912</span><span class="p">,</span>  <span class="c1"># 500 MB</span>
        <span class="n">use_blob_storage</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># relative</span>
        <span class="kn">from</span> <span class="nn">..tensor.autodp.gamma_tensor</span> <span class="kn">import</span> <span class="n">GammaTensor</span>
        <span class="kn">from</span> <span class="nn">..tensor.autodp.phi_tensor</span> <span class="kn">import</span> <span class="n">PhiTensor</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Loading dataset...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">assets</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Missing Assets: Oops!... You forgot to include your data! (or you passed it in the wrong way) </span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;You must call load_dataset() with a dictionary of assets which are the &quot;</span>
                <span class="s2">&quot;private dataset objects (tensors) you wish to allow someone else to study &quot;</span>
                <span class="s2">&quot;while PySyft protects it using various privacy enhancing technologies. </span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;For example, the MNIST dataset is comprised of 6 tensors, so we would create an assets &quot;</span>
                <span class="s2">&quot;dictionary with 6 keys (strings) mapping to the 6 tensors of MNIST.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Please pass in a dictionary where the key is the name of the asset and the value is &quot;</span>
                <span class="s2">&quot;the private dataset object (tensor) itself. We recommend uploading assets which &quot;</span>
                <span class="s2">&quot;are differential-privacy trackable objects, such as a syft.Tensor() wrapped &quot;</span>
                <span class="s2">&quot;numpy.int32 or numpy.float32 object which you &quot;</span>
                <span class="s2">&quot;then call .annotate_with_dp_metadata() on. </span><span class="se">\n\n</span><span class="s2">Once &quot;</span>
                <span class="s2">&quot;you have an assets dictionary call load_dataset(assets=&lt;your dict of objects&gt;).&quot;</span>
            <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Loading dataset... checking assets...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Missing Name: Oops!... You forgot to name your dataset!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;It&#39;s important to give your dataset a clear and descriptive name because&quot;</span>
                <span class="s2">&quot; the name is the primary way in which potential users of the dataset will&quot;</span>
                <span class="s2">&quot; identify it.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s1">&#39;Retry with a string name. I.e., .load_dataset(name=&quot;&lt;your name here&gt;)&quot;&#39;</span>
            <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Loading dataset... checking dataset name for uniqueness...&quot;</span><span class="p">)</span>

        <span class="c1"># Disabling this for now until we have a more efficient means of querying dataset metadata.</span>
        <span class="c1"># TODO: enforce name uniqueness through more efficient means.</span>
        <span class="c1"># datasets = self.datasets</span>
        <span class="c1"># if not skip_checks:</span>
        <span class="c1">#     for i in range(len(datasets)):</span>
        <span class="c1">#         d = datasets[i]</span>
        <span class="c1">#         sys.stdout.write(&quot;.&quot;)</span>
        <span class="c1">#         if name == d.name:</span>
        <span class="c1">#             print(</span>
        <span class="c1">#                 &quot;\n\nWARNING - Dataset Name Conflict: A dataset named &#39;&quot;</span>
        <span class="c1">#                 + name</span>
        <span class="c1">#                 + &quot;&#39; already exists.\n&quot;</span>
        <span class="c1">#             )</span>
        <span class="c1">#             pref = input(&quot;Do you want to upload this dataset anyway? (y/n)&quot;)</span>
        <span class="c1">#             while pref != &quot;y&quot; and pref != &quot;n&quot;:</span>
        <span class="c1">#                 pref = input(</span>
        <span class="c1">#                     &quot;Invalid input &#39;&quot; + pref + &quot;&#39;, please specify &#39;y&#39; or &#39;n&#39;.&quot;</span>
        <span class="c1">#                 )</span>
        <span class="c1">#             if pref == &quot;n&quot;:</span>
        <span class="c1">#                 raise Exception(&quot;Dataset loading cancelled.&quot;)</span>
        <span class="c1">#             else:</span>
        <span class="c1">#                 print()  # just for the newline</span>
        <span class="c1">#                 break</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Loading dataset... checking dataset name for uniqueness...&quot;</span>
            <span class="s2">&quot;                                                          &quot;</span>
            <span class="s2">&quot;                                                          &quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Missing Description: Oops!... You forgot to describe your dataset!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;It&#39;s *very* important to give your dataset a very clear and complete description&quot;</span>
                <span class="s2">&quot; because your users will need to be able to find this dataset (the description is used for search)&quot;</span>
                <span class="s2">&quot; AND they will need enough information to be able to know that the dataset is what they&#39;re&quot;</span>
                <span class="s2">&quot; looking for AND how to use it.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Start by describing where the dataset came from, how it was collected, and how its formatted.&quot;</span>
                <span class="s2">&quot;Refer to each object in &#39;assets&#39; individually so that your users will know which is which. Don&#39;t&quot;</span>
                <span class="s2">&quot; be afraid to be longwinded. :) Your users will thank you.&quot;</span>
            <span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Loading dataset... checking asset types...                              &quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_checks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="n">PhiTensor</span><span class="p">,</span> <span class="n">GammaTensor</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;ERROR: All private assets must have &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;proper Differential Privacy metadata applied.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;Example: syft.Tensor([1,2,3,4]).annotate_with_dp_metadata()</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;and then follow the wizard. 🧙&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># print(</span>
                    <span class="c1">#     &quot;\n\nWARNING - Non-DP Asset: You just passed in a asset &#39;&quot;</span>
                    <span class="c1">#     + asset_name</span>
                    <span class="c1">#     + &quot;&#39; which cannot be tracked with differential privacy because it is a &quot;</span>
                    <span class="c1">#     + str(type(asset))</span>
                    <span class="c1">#     + &quot; object.\n\n&quot;</span>
                    <span class="c1">#     + &quot;This means you&#39;ll need to manually approve any requests which &quot;</span>
                    <span class="c1">#     + &quot;leverage this data. If this is ok with you, proceed. If you&#39;d like to use &quot;</span>
                    <span class="c1">#     + &quot;automatic differential privacy budgeting, please pass in a DP-compatible tensor type &quot;</span>
                    <span class="c1">#     + &quot;such as by calling .annotate_with_dp_metadata() &quot;</span>
                    <span class="c1">#     + &quot;on a sy.Tensor with a np.int32 or np.float32 inside.&quot;</span>
                    <span class="c1"># )</span>
                    <span class="c1">#</span>
                    <span class="c1"># pref = input(&quot;Are you sure you want to proceed? (y/n)&quot;)</span>
                    <span class="c1">#</span>
                    <span class="c1"># while pref != &quot;y&quot; and pref != &quot;n&quot;:</span>
                    <span class="c1">#     pref = input(</span>
                    <span class="c1">#         &quot;Invalid input &#39;&quot; + pref + &quot;&#39;, please specify &#39;y&#39; or &#39;n&#39;.&quot;</span>
                    <span class="c1">#     )</span>
                    <span class="c1"># if pref == &quot;n&quot;:</span>
                    <span class="c1">#     raise Exception(&quot;Dataset loading cancelled.&quot;)</span>

        <span class="c1"># serialize metadata</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                <span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># blob storage can only be used if domain node has blob storage enabled.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_blob_storage&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">**Warning**: Blob Storage is disabled on this domain. Switching to database store.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">use_blob_storage</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># If one of the assets needs to be send to blob_storage, then store all other</span>
        <span class="c1"># assets to blob storage as well</span>
        <span class="n">send_assets_to_blob_storage</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">check_send_to_blob_storage</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span> <span class="n">use_blob_storage</span><span class="o">=</span><span class="n">use_blob_storage</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Loading dataset... uploading...🚀                        &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">send_assets_to_blob_storage</span><span class="p">:</span>
            <span class="c1"># upload to blob storage</span>
            <span class="n">proxy_assets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ProxyDataset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># send each asset to blob storage and pack the results back</span>
            <span class="k">for</span> <span class="n">asset_name</span><span class="p">,</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">proxy_obj</span> <span class="o">=</span> <span class="n">upload_to_s3_using_presigned</span><span class="p">(</span>
                    <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">asset</span><span class="p">,</span>
                    <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
                    <span class="n">asset_name</span><span class="o">=</span><span class="n">asset_name</span><span class="p">,</span>
                    <span class="n">dataset_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">proxy_assets</span><span class="p">[</span><span class="n">asset_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_obj</span>

            <span class="n">dataset_bytes</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span><span class="n">proxy_assets</span><span class="p">,</span> <span class="n">to_bytes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># upload directly</span>
            <span class="n">dataset_bytes</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span><span class="n">assets</span><span class="p">,</span> <span class="n">to_bytes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">create_syft</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">dataset_bytes</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">platform</span><span class="o">=</span><span class="s2">&quot;syft&quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">SAVE_DATASET_TIMEOUT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Dataset is uploaded successfully !!! 🎉&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Run `&lt;your client variable&gt;.datasets` to see your new dataset loaded into your machine!&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">budget</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">budget</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Budget should be a positive number, but got </span><span class="si">{</span><span class="n">budget</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">budget</span><span class="o">=</span><span class="n">budget</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="n">VirtualClientConnection</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
                <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">base_url</span><span class="o">.</span><span class="n">host_or_ip</span>  <span class="c1"># type: ignore</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, Openmined Community.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>